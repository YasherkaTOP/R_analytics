## **Выбор регионов, лидирующих по потребительской активности, безналичным платежам и внутреннему туризму**

```{r}
library(tidyverse)
library(readxl)
library(writexl)
library(psych)
library(ggplot2)
library(reshape2)
library(vcd)
df <- read_excel("Данные 2020.xlsx")
```

1.  Выведите описательные статистики для каждого показателя из группы СберИндекс. Прокомментируйте полученные результаты.

    ```{r}
    selected_columns <- c("Доля БП в торг. обороте", "Индекс ПА", "Кол-во внутр. тур.")
    describe(df[selected_columns])
    ```

2.  Для каждого показателя из группы СберИндекс постройте график, который показывал бы динамику среднего значения индекса по России в течение 2020 года. Приведите график в порядок, он пойдёт в ваш отчёт. Прокомментируйте полученные результаты.

    ```{r}
    month_order <- c("Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь")
    df$Месяц <- factor(df$Месяц, levels = month_order)

    plot_data <- aggregate(df[selected_columns], by = list(df$Месяц), FUN = mean)

    data_long <- melt(plot_data, id.vars = "Group.1")

    ggplot(data_long, aes(x = Group.1, y = value, color = variable, group = variable)) +
      geom_line(size = 1.2) +
      geom_point() +
      labs(title = "Динамика показателей по месяцам",
           x = "Месяц", y = "Значение", color = "Показатель") +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
    ```

    Выводы:

    -   Доля БП в торг. обороте имеет стабильность на протяжении всего года.

    -   Индекс ПА также примерно стабилен, однако в апреле произошёл спад (скорее всего из-за резкого снижения внутренних туристов).

    -   Туристы активны больше всего в холодный период (январь-март) и тёплый (Август-Сентябрь). После этих периодов происходит отток туристов, больше всего после холодного периода.

3.  Постройте ящики с усами для каждого показателя из группы СберИндекс (исходные данные, не средние по России) с группировкой по месяцу. У вас должен получиться график с 12 окнами-фасетками с тремя ящиками с усами в каждом. Приведите график в порядок, он пойдёт в ваш отчёт. Прокомментируйте полученные результаты.

    ```{r}
    ggplot(df, aes(x = Месяц)) +
      geom_boxplot(aes(y = `Доля БП в торг. обороте`, color = "Доля БП в торг. обороте"), width = 0.2) +
      geom_boxplot(aes(y = `Индекс ПА`, color = "Индекс ПА"), width = 0.2) +
      geom_boxplot(aes(y = `Кол-во внутр. тур.`, color = "Кол-во внутр. тур."), width = 0.2) +
      scale_color_manual(values = c("Доля БП в торг. обороте" = "red", 
                                    "Индекс ПА" = "blue", 
                                    "Кол-во внутр. тур." = "green")) +
      facet_wrap(~Месяц, scales = "free") +
      labs(x = "Месяц", y = "Значение", color = "Показатель") +
      theme_minimal()
    ```

    Выводы:

    -   По этим графикам видно, что распределение у показателей разное, скорее всего есть некоторые выбросы или аномалии.

    -   Показатель кол-ва туристов имеет самый большой разброс в каждом месяце.

4.  Проверьте, есть ли среди значений показателей из группы СберИндекс нетипичные наблюдения. Если есть, укажите их для каждого месяца. Сохраните строки, соответствующие нетипичным наблюдениям, в отдельный датафрейм. Предложите свои объяснения, почему такие нетипичные значения могли возникнуть.

    ```{r}
    find_outliers <- function(column) {
      q1 <- quantile(column, 0.25)
      q3 <- quantile(column, 0.75)
      iqr <- q3 - q1
      lower_bound <- q1 - 1.5 * iqr
      upper_bound <- q3 + 1.5 * iqr
      outliers <- column[column < lower_bound | column > upper_bound]
      return(outliers)
    }

    outliers <- lapply(df[selected_columns], find_outliers)

    outliers_df <- df %>% 
      filter(
        `Доля БП в торг. обороте` %in% outliers$`Доля БП в торг. обороте` |
          `Индекс ПА` %in% outliers$`Индекс ПА` |
          `Кол-во внутр. тур.` %in% outliers$`Кол-во внутр. тур.`
      )
    ```

    Вывод: Причиной может быть ошибка в мониторинге, какие-то события в регионе или стране.

5.  Определите, в каких регионах в среднем потребителей можно считать наиболее активными, а в каких — наименее активными. Выберите 30 наиболее активных регионов и сохраните их в отдельный датафрейм.

    ```{r}
    df_grouped <- df %>%
      group_by(Регион) %>%
      summarize(Средний_Индекс_ПА = mean(`Индекс ПА`, na.rm = TRUE)) %>%
      arrange(desc(Средний_Индекс_ПА))

    top_30_active_regions <- df_grouped %>%
      top_n(30, wt = Средний_Индекс_ПА)
    ```

6.  Определите, какие регионы, в среднем, лидируют по доле безналичных платежей. Выберите 30 регионов с наибольшей средней долей безналичных платежей.

    ```{r}
    df_grouped <- df %>%
      group_by(Регион) %>%
      summarize(Средняя_доля_БП = mean(`Доля БП в торг. обороте`, na.rm = TRUE)) %>%
      arrange(desc(Средняя_доля_БП))

    top_30_bp_regions <- df_grouped %>%
      top_n(30, wt = Средняя_доля_БП)
    ```

7.  Выберите те регионы, которые одновременно лидируют по потребительской активности и доле безналичных платежей. Другими словами, найдите регионы, общие для списков, полученных в пунктах 5 и 6. Перечислите эти регионы.

    ```{r}
    common_regions <- intersect(top_30_active_regions$Регион, top_30_bp_regions$Регион)
    common_regions
    ```

8.  Выберите строки, соответствующие регионам из предыдущего пункта, и сохраните их в отдельный датафрейм.

    ```{r}
    filtered_df_top30_common <- df %>%
      filter(Регион %in% common_regions)
    ```

9.  Определите, в каких регионах среди отобранных на предыдущих шагах, индекс внутреннего туризма принимал значения выше 0 не менее чем в течение 5 месяцев (не обязательно подряд). Перечислите эти регионы.

    ```{r}
    region_counts <- filtered_df_top30_common %>%
      group_by(Регион) %>%
      summarize(Кол_месяцев_выше_0 = sum(`Кол-во внутр. тур.` > 0))

    regions_above_0 <- region_counts %>%
      filter(Кол_месяцев_выше_0 >= 5)

    print(regions_above_0$Регион)
    ```

10. Выберите строки, соответствующие регионам из предыдущего пункта, и сохраните их в отдельный датафрейм.

    ```{r}
    region_list <- regions_above_0$Регион

    top_Regions <- df %>%
      filter(Регион %in% region_list)
    ```

11. Используя результаты, полученные в предыдущих пунктах, сформулируйте рекомендации Михаилу: на какие регионы при планировании открытия филиалов банка ему нужно обратить внимание. Укажите:

    -   месяцы, в которые потребители этих регионов наиболее активны;

    -   месяцы, в которые потребители этих регионов чаще всего совершают безналичные платежи;

    -   месяцы, в которые эти регионы чаще всего посещают внутренние туристы.

    ```{r}
    # ПА
    monthly_activity <- top_Regions %>%
      group_by(Месяц) %>%
      summarize(Средний_Индекс_ПА = mean(`Индекс ПА`))

    top_three_months <- monthly_activity %>%
      arrange(desc(Средний_Индекс_ПА)) %>%
      head(3)
    top_three_months
    ```

```{r}
# БП
monthly_activity <- top_Regions %>%
  group_by(Месяц) %>%
  summarize(Средняя_доля_БП = mean(`Доля БП в торг. обороте`))

top_three_months <- monthly_activity %>%
  arrange(desc(Средняя_доля_БП)) %>%
  head(3)
top_three_months
```

```{r}
# Внутр. туристы.
monthly_activity <- top_Regions %>%
  group_by(Месяц) %>%
  summarize(Внутр_тур = mean(`Кол-во внутр. тур.`))

top_three_months <- monthly_activity %>%
  arrange(desc(Внутр_тур)) %>%
  head(3)
top_three_months
```

Выводы:

-   Обратить внимание на регионы: "Калининградская область","Камчатский край","Кировская область","Ненецкий автономный округ","Нижегородская область".

-   Месяцы с самой высокой ПА: июль, август, сентябрь.

-   Месяцы с самой высокой долей БП: октябрь, ноябрь, декабрь.

-   Месяцы с самым высоким кол-вом внутр. туристов: август, сентябрь, февраль.

## **Поиск взаимосвязей**

1.  Постройте диаграмму рассеивания, которая визуализировала бы связь между показателями Индекс безналичных платежей и Индекс внутреннего туризма. Приведите график в порядок, он пойдёт в ваш отчёт.

    ```{r}
    ggplot(top_Regions, aes(x = `Доля БП в торг. обороте`, y = `Кол-во внутр. тур.`)) +
      geom_point() +  # Точечный график
      labs(x = "Доля БП в торг. обороте", y = "Кол-во внутр. тур.",
           title = "Диаграмма рассеивания между Доля БП в торг. обороте и Кол-во внутр. тур.")
    ```

2.  Проверьте формально, можно ли считать показатели Индекс безналичных платежей и Индекс внутреннего туризма связанными. Если да, укажите направление и силу связи.

    ```{r}
    cor.test(top_Regions$`Доля БП в торг. обороте`, top_Regions$`Кол-во внутр. тур.`)
    ```

    Сила связи: средняя

    Направление связи: положительная

3.  Используя результаты пунктов 1 и 2, прокомментируйте, можно ли считать предположение Михаила о том, что в регионах, которые более активно посещаются туристами, доля безналичных платежей выше.

    Да, можно. Как выяснил ранее, есть не слабая положительная связь.

4.   Проверьте формально, можно ли считать, что в тех регионах, где жители чаще берут кредиты, число ипотечных сделок также выше. Для ответа на этот вопрос, возможно, понадобится поработать со шкалами указанных показателей.

    ```{r}
    top_Regions <- top_Regions %>%
      mutate(`Всего одобр. заявок` = factor(`Всего одобр. заявок`, levels = c("100 - 500", "500 - 1 000", "1 000 - 5 000")),
             `Всего ипотечных сделок` = factor(`Всего ипотечных сделок`, levels = c("50 - 100", "100 - 500", "500 - 1 000", "> 1 000")))

    ggplot(top_Regions, aes(x = `Всего одобр. заявок`, y = `Всего ипотечных сделок`)) +
      geom_point() +
      labs(x = "Всего одобренных заявок", y = "Всего ипотечных сделок") +
      ggtitle("Диаграмма рассеивания")
    ```

    ```{r}
    assocstats(table(top_Regions$`Всего одобр. заявок`, top_Regions$`Всего ипотечных сделок`))
    ```

    Ответ: да, по графику чётко видно, а также корелляция достаточно сильная и положительная.

5.  Проверьте формально, можно ли считать, что в тех регионах, где доля безналичных платежей выше, жители чаще подают заявки на кредиты онлайн.

    ```{r}
    ggplot(top_Regions, aes(x = `Доля БП в торг. обороте`, y = `Доля онлайн-заявок`)) +
      geom_point() +
      labs(x = "Доля БП в торг. обороте", y = "Доля онлайн-заявок") +
      ggtitle("Диаграмма рассеивания")
    ```

    ```{r}
    cor.test(top_Regions$`Доля БП в торг. обороте`, top_Regions$`Доля онлайн-заявок`)
    ```

    Ответ: Да, можно считать, корелляция средняя и положительная.

6.  Обобщите выводы, полученные в пунктах 4 и 5, и включите их в отчёт для Михаила. В качестве подтверждения ваших выводов не забудьте включить в отчёт выдачи R, подтверждающие ваши мысли.

    Выводы:

    -   Если растёт доля онлайн заявок на кредиты, то растёт доля безнал платежей.

7.  Добавьте в датафрейм столбец Сезон, который содержит следующие значения в зависимости от месяца наблюдения: зима, весна, лето, осень.

    ```{r}
    top_Regions <- top_Regions %>%
      mutate(Сезон = case_when(
        Месяц %in% c("Декабрь", "Январь", "Февраль") ~ "зима",
        Месяц %in% c("Март", "Апрель", "Май") ~ "весна",
        Месяц %in% c("Июнь", "Июль", "Август") ~ "лето",
        Месяц %in% c("Сентябрь", "Октябрь", "Ноябрь") ~ "осень",
      ))
    ```

8.  Постройте столбиковую диаграмму, которая бы иллюстрировала соотношение количества ипотечных сделок, заключённых в разное время года, для каждой категории числа ипотечных сделок (10–50, 50–100, 100–500, 500–1000, больше 1000). Приведите график в порядок, он пойдёт в ваш отчёт. Прокомментируйте полученный график и зафиксируйте, когда жители регионов России чаще всего заключают сделки по ипотеке.

    ```{r}
    pivot_table <- top_Regions %>%
      mutate(Сезон = factor(Сезон, levels = c("зима", "весна", "лето", "осень"))) %>%
      group_by(Сезон, `Всего ипотечных сделок`) %>%
      summarise(`Количество_сделок` = n())

    ggplot(pivot_table, aes(x = Сезон, y = Количество_сделок, fill = `Всего ипотечных сделок`)) +
      geom_bar(stat = "identity", position = "dodge") +
      labs(title = "Соотношение количества по временам года и категориям числа сделок",
           x = "Время года", y = "Количество сделок",
           fill = "Категория числа сделок") +
      theme_minimal()
    ```

    Вывод:

    -   Больше всего жители заключают сделки по ипотеке осенью.

9.  Постройте ящики с усами, которые бы показывали распределение доли онлайн-заявок на кредиты в зависимости от времени года. Можно ли, глядя на графики, понять, в какое время года люди чаще оформляют кредиты посредством онлайн-заявок? Если да, укажите это время года и приведите необходимые пояснения. Предложите свои идеи, объясняющие различия в количестве онлайн-заявок в зависимости от сезона.

    ```{r}
    ggplot(top_Regions, aes(x = Сезон, y = `Доля онлайн-заявок`)) +
      geom_boxplot(fill = "lightblue", color = "blue") +
      labs(x = "Время года", y = "Доля онлайн-заявок",
           title = "Распределение доли онлайн-заявок в зависимости от времени года") +
      theme_minimal()
    ```

    Выводы:

    -   Да, можно. Чаще всего весной (верхняя граница выше остальных), скорее всего, потому что погода весной бывает отвратительной и многим не хочется идти/ехать в офис. Возможно, весной многие люди находятся в занятом состоянии из-за планирования дел на лето, поэтому предпочитают онлайн.

10. Проверьте формально, можно ли считать, что доля онлайн-заявок на кредиты зависит от времени года. Проинтерпретируйте полученные результаты. 

    ```{r}
    ggplot(top_Regions, aes(x = `Сезон`, y = `Доля онлайн-заявок`)) +
      geom_point() +
      labs(x = "Сезон", y = "Доля онлайн-заявок") +
      ggtitle("Диаграмма рассеивания")
    ```

    Вывод: Особой зависимости не видно, во все три сезона, кроме зимы, медиана примерно равна.

11. Постройте ящики с усами, которые бы показывали распределение доли ипотечных сделок на вторичное жильё в зависимости от времени года. Можно ли, глядя на графики, понять, в какое время года люди чаще заключают сделки на вторичное жильё? Если да, укажите это время года и приведите необходимые пояснения. Предложите свои идеи, объясняющие различия в количестве сделок по «вторичке» в зависимости от сезона.

    ```{r}
    ggplot(top_Regions, aes(x = Сезон, y = `Доля вторичка`)) +
      geom_boxplot(fill = "lightblue", color = "blue") +
      labs(x = "Время года", y = "Доля вторички",
           title = "Распределение доли вторички в зависимости от времени года") +
      theme_minimal()
    ```

    Вывод: Да, весной доля на вторичку больше. Люди, планирующие переезд могут сознательно выбирать весенний период из-за лучших условий для переезда, именно вторчика часто доступнее и может быть готова к заселению быстрее (опять же потому что весной у людей много дел).

12. Проверьте формально, можно ли считать, что доля ипотечных сделок на вторичное жильё зависит от времени года. Проинтерпретируйте полученные результаты.

    ```{r}
    ggplot(top_Regions, aes(x = `Сезон`, y = `Доля вторичка`)) +
      geom_point() +
      labs(x = "Сезон", y = "Доля вторичка") +
      ggtitle("Диаграмма рассеивания")
    ```

    Вывод: зависимость есть, медианные значения немного различаются.

13. Обобщите результаты, полученные в пунктах 8–12. Подумайте, для чего эти результаты могут пригодиться Михаилу, и включите свои идеи в отчёт. В качестве подтверждения выводов не забудьте включить в отчёт выдачи R, подтверждающие ваши мысли.

    Вывод:

    -   Самым активным сезоном является осень.
